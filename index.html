<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pranayama Timer</title>
  <style>
    /* --- Base Styles (Mobile-First) --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: #e0f7fa;
      color: #004d40;
      padding: 15px;
      transition: background 0.5s, color 0.5s;
      margin: 0;
    }
    h1, h2 {
      font-weight: 300;
      margin-bottom: 20px;
    }
    h1 { font-size: 2.2em; }
    h2 { font-size: 1.8em; }
    .container {
      margin: 20px auto;
      max-width: 500px;
    }

    /* --- Screen Management --- */
    .screen {
        display: none; /* Hide screens by default */
    }
    .screen.active {
        display: block; /* Show only the active screen */
    }

    /* --- Responsive Control Layouts --- */
    .controls { text-align: left; }
    .controls > label { display: block; margin-bottom: 20px; }
    #presetSelect { width: 100%; margin-top: 5px; }
    .timing-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .cycles-control { margin-bottom: 20px; }
    .timing-inputs label, .cycles-control label { display: flex; flex-direction: column; font-size: 0.95em; }
    .controls input, .controls select, .settings-grid select {
        width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #00796b;
        border-radius: 5px; background-color: #f1f1f1; color: #004d40; box-sizing: border-box;
    }
    .controls #savePresetBtn { width: 100%; margin-top: 5px; }

    /* --- Settings Screen Layout --- */
    .settings-grid {
      display: grid; grid-template-columns: 1fr; gap: 20px; text-align: left;
    }
    .checkboxes label { display: block; margin-bottom: 12px; cursor: pointer; }
    .selectors label { display: block; margin-bottom: 5px; }
    .selectors select { width: 100%; }

    /* --- Visual Timer & Progress Bar --- */
    .circle {
      width: 150px; height: 150px; margin: 30px auto; border-radius: 50%; background: #80cbc4;
      display: flex; justify-content: center; align-items: center; transition: background 0.5s, transform 0.5s ease-out;
    }
    .stage, .timer { font-size: 2em; margin: 10px; }
    .progress-bar {
      background: #b2dfdb; border-radius: 20px; overflow: hidden; height: 20px; transition: background 0.5s;
    }
    .progress-fill {
      background: #00796b; height: 100%; width: 0%; transition: width 0.5s ease-in-out, background 0.5s;
    }

    /* --- Buttons --- */
    button, .file-input-label {
      margin: 5px 0; padding: 12px 20px; font-size: 1em; background: #00796b;
      color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s;
    }
    button:hover:not(:disabled), .file-input-label:hover { background: #004d40; }
    button:disabled { background: #9e9e9e; cursor: not-allowed; }
    .action-buttons { display: flex; gap: 10px; }
    .action-buttons button { flex-grow: 1; }
    #settingsScreen .container:first-of-type { margin-top: 0; }
    #backBtn { width: 100%; }

    /* --- Responsive Music Controls --- */
    .music-controls {
      display: flex; flex-direction: column; gap: 12px; align-items: stretch;
    }
    #volumeSlider { cursor: pointer; width: 100%; box-sizing: border-box; }
    #musicFileInput { display: none; }
    #musicFileName { width: 100%; font-style: italic; font-size: 0.9em; margin-top: 5px; }

    /* --- Themes --- */
    body.theme-dark{background:#121212;color:#e0f7fa}.theme-dark .controls input,.theme-dark .controls select,.theme-dark .settings-grid select{background-color:#333;color:#e0f7fa;border-color:#26a69a}.theme-dark .circle{background:#26a69a}.theme-dark .progress-bar{background:#444}.theme-dark .progress-fill{background:#80cbc4}.theme-dark button,.theme-dark .file-input-label{background:#26a69a}.theme-dark button:hover:not(:disabled),.theme-dark .file-input-label:hover{background:#00796b}.theme-dark button:disabled{background:#555}
    body.theme-ocean{background:#0F2027;color:#EAEFBD}.theme-ocean .controls input,.theme-ocean .controls select,.theme-ocean .settings-grid select{background-color:#2C5364;color:#EAEFBD;border-color:#203A43}.theme-ocean .circle{background:#2980B9}.theme-ocean .progress-bar{background:#203A43}.theme-ocean .progress-fill{background:#BBD2C5}.theme-ocean button,.theme-ocean .file-input-label{background:#2C5364}.theme-ocean button:hover:not(:disabled),.theme-ocean .file-input-label:hover{background:#203A43}
    body.theme-forest{background:#134E5E;color:#F0F2F0}.theme-forest .controls input,.theme-forest .controls select,.theme-forest .settings-grid select{background-color:#5A8F7B;color:#F0F2F0;border-color:#71B280}.theme-forest .circle{background:#81B29A}.theme-forest .progress-bar{background:#5A8F7B}.theme-forest .progress-fill{background:#71B280}.theme-forest button,.theme-forest .file-input-label{background:#71B280}.theme-forest button:hover:not(:disabled),.theme-forest .file-input-label:hover{background:#5A8F7B}
    body.theme-sunset{background:#42275a;color:#FDEB71}.theme-sunset .controls input,.theme-sunset .controls select,.theme-sunset .settings-grid select{background-color:#734b6d;color:#FDEB71;border-color:#FDEB71}.theme-sunset .circle{background:#f857a6}.theme-sunset .progress-bar{background:#734b6d}.theme-sunset .progress-fill{background:#ff5858}.theme-sunset button,.theme-sunset .file-input-label{background:#734b6d}.theme-sunset button:hover:not(:disabled),.theme-sunset .file-input-label:hover{background:#42275a}

    /* --- Media Query for Larger Screens --- */
    @media (min-width: 550px) {
      h1 { font-size: 2.5em; }
      .controls #savePresetBtn { width: auto; }
      .settings-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
      .music-controls { flex-direction: row; align-items: center; flex-wrap: wrap; justify-content: center; }
      #volumeSlider { width: 120px; }
    }
  </style>
</head>
<body>

  <div id="mainScreen" class="screen active">
    <h1>üßò Pranayama Timer</h1>
    <div class="container controls" id="controls">
      <label>Preset
        <select id="presetSelect" onchange="loadPreset(this.value)">
          <option value="">-- Choose Preset --</option>
          <option value="box">Box Breathing (4-4-4-4)</option>
          <option value="478">4-7-8 Method</option>
          <option value="custom">Custom (saved)</option>
        </select>
      </label>
      <div class="timing-inputs">
          <label>Inhale <input id="inhale" type="number" value="4" min="0" /></label>
          <label>Hold <input id="hold1" type="number" value="4" min="0" /></label>
          <label>Exhale <input id="exhale" type="number" value="4" min="0" /></label>
          <label>Hold <input id="hold2" type="number" value="4" min="0" /></label>
      </div>
      <div class="cycles-control">
          <label>Cycles <input id="cycles" type="number" value="5" min="1"/></label>
      </div>
      <button id="savePresetBtn" onclick="savePreset()">üíæ Save as Custom</button>
    </div>

    <div class="stage" id="stage">Ready?</div>
    <div class="circle" id="circle">
        <div class="timer" id="timer">0</div>
    </div>

    <div class="container progress-container">
      <div id="progressText">Cycle 0 / 5</div>
      <div class="progress-bar">
        <div id="progressBar" class="progress-fill"></div>
      </div>
    </div>

    <div class="container action-buttons">
        <button id="startButton" onclick="startBreathing()">‚ñ∂Ô∏è Start</button>
        <button id="stopButton" onclick="stopBreathing()" disabled>‚èπÔ∏è Stop</button>
    </div>
    
    <div class="container">
      <button id="settingsBtn">‚öôÔ∏è Settings</button>
    </div>
  </div>

  <div id="settingsScreen" class="screen">
    <h2>Settings</h2>
    <div class="container">
        <button id="backBtn">‚¨ÖÔ∏è Back to Timer</button>
    </div>
    <div class="container settings-grid">
      <div class="checkboxes">
          <h3>Sound Options</h3>
          <label><input type="checkbox" id="enableBeep" checked /> üîä Enable Transition Sound</label>
          <label><input type="checkbox" id="enableMusic" checked /> üéµ Enable Background Music</label>
          <label><input type="checkbox" id="enableVoice" checked /> üó£Ô∏è Enable Voice Guidance</label>
      </div>
      <div class="selectors">
          <h3>Appearance</h3>
          <label for="themeSelect">üé® Theme</label>
          <select id="themeSelect" onchange="applyTheme(this.value)">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="ocean">Ocean</option>
              <option value="forest">Forest</option>
              <option value="sunset">Sunset</option>
          </select>
          <label for="transitionSoundSelect" style="margin-top: 15px;">üîî Transition Sound</label>
          <select id="transitionSoundSelect" onchange="changeTransitionSound(this.value)">
              <option value="beep">Beep</option>
              <option value="bell">Bell</option>
              <option value="click">Click</option>
          </select>
      </div>
    </div>
    <div class="container music-controls">
        <h3>Music Controls</h3>
        <button onclick="toggleMusic()">üéµ Play/Pause</button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.2" oninput="updateVolume()">
        <select id="backgroundMusicSelect" onchange="changeBackgroundMusic(this.value)">
            <option value="localForest">Forest Lullaby (Local)</option>
            <option value="forest">Forest (Online)</option>
            <option value="rain">Rain</option>
            <option value="waves">Waves</option>
            <option value="bowl">Singing Bowl</option>
            <option value="none">No Music</option>
        </select>
        <label for="musicFileInput" class="file-input-label">üìÇ Custom</label>
        <input type="file" id="musicFileInput" accept="audio/mp3,audio/wav,audio/ogg" onchange="loadLocalMusic(event)">
    </div>
    <div id="musicFileName" class="container">Playing default sounds.</div>
  </div>


  <audio id="transitionAudio" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="bgmusic" src="forest-lullaby.mp3" loop preload="auto"></audio>

  <script>
    // --- Data for Sound Libraries ---
    const backgroundTracks = {
        'localForest': 'forest-lullaby.mp3',
        'forest': 'https://actions.google.com/sounds/v1/ambience/forest_sounds.ogg',
        'rain': 'https://actions.google.com/sounds/v1/weather/rain.ogg',
        'waves': 'https://actions.google.com/sounds/v1/ambience/ocean_waves.ogg',
        'bowl': 'https://actions.google.com/sounds/v1/ambience/meditation.ogg',
        'none': ''
    };
    const transitionSounds = {
        'beep': 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg',
        'bell': 'https://actions.google.com/sounds/v1/bells/bell_tree.ogg',
        'click': 'https://actions.google.com/sounds/v1/ui/ui_tap_hard.ogg'
    };
    const presets = {
        'box': { inhale: 4, hold1: 4, exhale: 4, hold2: 4 },
        '478': { inhale: 4, hold1: 7, exhale: 8, hold2: 0 }
    };
    
    // --- DOM Elements ---
    const settingsBtn = document.getElementById('settingsBtn');
    const backBtn = document.getElementById('backBtn');
    const transitionAudioEl = document.getElementById("transitionAudio");
    const bgMusicEl = document.getElementById("bgmusic");
    const themeSelectEl = document.getElementById("themeSelect");
    const transitionSoundSelectEl = document.getElementById("transitionSoundSelect");
    const backgroundMusicSelectEl = document.getElementById("backgroundMusicSelect");
    const inhaleEl = document.getElementById("inhale"), hold1El = document.getElementById("hold1"), exhaleEl = document.getElementById("exhale"), hold2El = document.getElementById("hold2"), cyclesEl = document.getElementById("cycles"), circle = document.getElementById("circle"), timerEl = document.getElementById("timer"), stageEl = document.getElementById("stage"), startBtn = document.getElementById("startButton"), stopBtn = document.getElementById("stopButton"), controlsDiv = document.getElementById("controls"), volumeSlider = document.getElementById("volumeSlider"), musicFileNameEl = document.getElementById("musicFileName");
    const ALL_THEMES = ['light', 'dark', 'ocean', 'forest', 'sunset'];

    // --- State Variables ---
    let stages = [], stageIndex = 0, interval, secondsLeft = 0, cycleCount = 0, totalCycles = 0, musicObjectURL = null, isRunning = false;

    // --- Screen Navigation ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }
    settingsBtn.addEventListener('click', () => showScreen('settingsScreen'));
    backBtn.addEventListener('click', () => showScreen('mainScreen'));


    // --- Sound and Theme Functions ---
    function applyTheme(themeName) {
        document.body.classList.remove(...ALL_THEMES.map(t => `theme-${t}`));
        if (themeName !== 'light') document.body.classList.add(`theme-${themeName}`);
        localStorage.setItem('pranayamaTheme', themeName);
    }
    function changeTransitionSound(soundKey) {
        transitionAudioEl.src = transitionSounds[soundKey];
        localStorage.setItem('pranayamaTransitionSound', soundKey);
    }
    function changeBackgroundMusic(trackKey, isCustom = false) {
        if (musicObjectURL) { URL.revokeObjectURL(musicObjectURL); musicObjectURL = null; }
        const wasPlaying = !bgMusicEl.paused;
        bgMusicEl.src = backgroundTracks[trackKey];
        if (!isCustom) {
            localStorage.setItem('pranayamaBackgroundMusic', trackKey);
            musicFileNameEl.textContent = trackKey === 'none' ? "Music disabled." : `Playing: ${backgroundMusicSelectEl.options[backgroundMusicSelectEl.selectedIndex].text}`;
        }
        if (wasPlaying && bgMusicEl.src) bgMusicEl.play();
    }
    function loadLocalMusic(event) {
        const file = event.target.files[0];
        if (!file) return;
        changeBackgroundMusic('none', true);
        musicObjectURL = URL.createObjectURL(file);
        bgMusicEl.src = musicObjectURL;
        musicFileNameEl.textContent = `Playing custom: ${file.name}`;
        if (!bgMusicEl.paused) { bgMusicEl.pause(); if (bgMusicEl.src) bgMusicEl.play(); }
    }
    function loadSavedSettings() {
        const savedTheme = localStorage.getItem('pranayamaTheme') || 'light';
        themeSelectEl.value = savedTheme;
        applyTheme(savedTheme);
        const savedTransitionSound = localStorage.getItem('pranayamaTransitionSound') || 'beep';
        transitionSoundSelectEl.value = savedTransitionSound;
        changeTransitionSound(savedTransitionSound);
        const savedBackgroundMusic = localStorage.getItem('pranayamaBackgroundMusic') || 'localForest';
        backgroundMusicSelectEl.value = savedBackgroundMusic;
        changeBackgroundMusic(savedBackgroundMusic);
    }

    // --- Core Timer and UI Functions ---
    function loadPreset(name) {
      if (name === "custom") { loadCustomPreset(); return; }
      if (!presets[name]) return;
      const p = presets[name];
      inhaleEl.value = p.inhale; hold1El.value = p.hold1; exhaleEl.value = p.exhale; hold2El.value = p.hold2;
    }
    function savePreset() {
      const preset = { inhale: inhaleEl.value, hold1: hold1El.value, exhale: exhaleEl.value, hold2: hold2El.value };
      localStorage.setItem("customBreathing", JSON.stringify(preset));
      alert("Custom preset saved!");
    }
    function loadCustomPreset() {
      const preset = JSON.parse(localStorage.getItem("customBreathing"));
      if (preset) { inhaleEl.value = preset.inhale; hold1El.value = preset.hold1; exhaleEl.value = preset.exhale; hold2El.value = preset.hold2; }
      else { alert("No custom preset saved yet!"); document.getElementById('presetSelect').value = ""; }
    }
    function startBreathing() {
        if (isRunning) return;
        isRunning = true;
        toggleControls(false);
        const inhale = parseInt(inhaleEl.value), hold1 = parseInt(hold1El.value), exhale = parseInt(exhaleEl.value), hold2 = parseInt(hold2El.value);
        totalCycles = parseInt(cyclesEl.value);
        cycleCount = 0;
        updateProgressBar();
        stages = [];
        if (inhale > 0) stages.push({ name: "Inhale", duration: inhale });
        if (hold1 > 0) stages.push({ name: "Hold", duration: hold1 });
        if (exhale > 0) stages.push({ name: "Exhale", duration: exhale });
        if (hold2 > 0) stages.push({ name: "Hold", duration: hold2 });
        if (stages.length === 0) { alert("Please set a duration for at least one stage."); stopBreathing(); return; }
        stageIndex = 0;
        if (document.getElementById("enableMusic").checked && bgMusicEl.src) {
            bgMusicEl.play().catch(e => console.error("Error playing music:", e));
        }
        nextStage();
    }
    function stopBreathing() {
        isRunning = false;
        clearInterval(interval);
        toggleControls(true);
        resetUI();
        bgMusicEl.pause();
        if (bgMusicEl.src) bgMusicEl.currentTime = 0;
    }
    function nextStage() {
      const stage = stages[stageIndex];
      secondsLeft = stage.duration;
      stageEl.textContent = stage.name;
      timerEl.textContent = secondsLeft;
      updateCircle(stage.name, stage.duration);
      if (document.getElementById("enableBeep").checked) playTransitionSound();
      if (document.getElementById("enableVoice").checked) speak(stage.name);
      clearInterval(interval);
      interval = setInterval(() => {
        secondsLeft--;
        timerEl.textContent = secondsLeft;
        if (secondsLeft <= 0) {
          clearInterval(interval);
          stageIndex = (stageIndex + 1) % stages.length;
          if (stageIndex === 0) {
            cycleCount++;
            updateProgressBar();
            if (cycleCount >= totalCycles) {
              speak("Session complete.");
              stageEl.textContent = "Done! ‚ú®";
              stopBreathing();
              return;
            }
          }
          nextStage();
        }
      }, 1000);
    }
    function updateCircle(stageName, duration) {
      const newTransition = `transform ${duration}s linear`;
      if (circle.style.transition !== newTransition) circle.style.transition = newTransition;
      if (stageName === "Inhale") circle.style.transform = "scale(1.5)";
      else if (stageName === "Exhale") circle.style.transform = "scale(1)";
    }
    function playTransitionSound() {
      transitionAudioEl.currentTime = 0;
      transitionAudioEl.play();
    }
    function speak(text) {
      if (!window.speechSynthesis) return;
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 0.9; utter.volume = 0.8;
      speechSynthesis.speak(utter);
    }
    function toggleMusic() {
        updateVolume();
        if (bgMusicEl.paused) bgMusicEl.play();
        else bgMusicEl.pause();
    }
    function updateVolume() { bgMusicEl.volume = parseFloat(volumeSlider.value); }
    function updateProgressBar() {
      const pct = totalCycles > 0 ? (cycleCount / totalCycles) * 100 : 0;
      document.getElementById("progressBar").style.width = `${pct}%`;
      document.getElementById("progressText").textContent = `Cycle ${cycleCount} / ${totalCycles}`;
    }
    function toggleControls(enable) {
        startBtn.disabled = !enable;
        stopBtn.disabled = enable;
        settingsBtn.disabled = !enable;
        document.querySelectorAll('.controls input, .controls select').forEach(el => el.disabled = !enable);
    }
    function resetUI() {
        stageEl.textContent = "Ready?";
        timerEl.textContent = "0";
        circle.style.transition = 'transform 0.5s ease-out';
        circle.style.transform = 'scale(1)';
        totalCycles = parseInt(cyclesEl.value) || 5;
        cycleCount = 0;
        updateProgressBar();
    }

    // Initialize on page load
    window.onload = () => {
        updateVolume();
        resetUI();
        loadSavedSettings();
        changeBackgroundMusic(backgroundMusicSelectEl.value);
    };
  </script>
</body>
</html>